name: mcryptoex-ci

on:
  push:
    branches: ["main"]
  pull_request:

jobs:
  contracts:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: packages/contracts
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: packages/contracts/package-lock.json
      - run: npm ci
      - run: npm run compile
      - run: npm test

  web:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/web
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: apps/web/package-lock.json
      - run: npm ci
      - run: npm run build

  api-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - run: python scripts/generate_chain_registry.py
      - run: python -m pip install --upgrade pip
      - run: pip install -r apps/api/requirements.txt
      - run: PYTHONPATH=. python -m unittest discover -s apps/api/tests -p 'test_*.py'

  security:
    runs-on: ubuntu-latest
    needs: [contracts, web, api-tests]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install contract deps
        run: npm ci
        working-directory: packages/contracts
      - name: Install web deps
        run: npm ci
        working-directory: apps/web
      - name: Install scan tools
        run: |
          python scripts/generate_chain_registry.py
          python -m pip install --upgrade pip
          pip install -r apps/api/requirements.txt
          pip install bandit pip-audit slither-analyzer
      - name: Local security bundle
        run: ./scripts/security_check.sh
      - name: Bandit (Python SAST)
        run: bandit -r apps/api services -q
      - name: pip-audit (dependency scan)
        run: pip-audit -r apps/api/requirements.txt
        continue-on-error: true
      - name: npm audit web
        run: npm audit --audit-level=high --omit=dev
        working-directory: apps/web
        continue-on-error: true
      - name: npm audit contracts
        run: npm audit --audit-level=high
        working-directory: packages/contracts
        continue-on-error: true
